rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Allow admins to read/write anything
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // Settings collection
    match /settings/{settingId} {
      // Allow any authenticated user (including server-side flows) to read settings
      allow read: if isAuth();
      // Only admins can write settings
      allow write: if isAdmin();
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read/write their own document
      allow read, write: if isUser(userId);
      // Other authenticated users can read public profiles
      allow read: if isAuth();
    }

    // Game Rooms can be read by anyone to populate lobbies
    match /game_rooms/{roomId} {
      allow read: if true;
      // Write/update rules should be more specific if needed
      // For now, only authenticated users can create/update
      allow write: if isAuth();
    }
    
    // Game chat messages
    match /game_rooms/{roomId}/messages/{messageId} {
      allow read, write: if isAuth();
    }
    
    // Other collections can be added here
    match /marketing_applications/{appId} {
      allow create; // Anyone can apply
      allow read, update, delete: if isAdmin();
    }
    
    match /transactions/{txId} {
       allow read, create: if isAuth();
       allow update: if isAdmin();
    }
    
    match /chats/{chatId} {
        allow read, write: if isAuth() && resource.data.users[request.auth.uid].exists == true;
    }
    
    match /chats/{chatId}/messages/{messageId} {
       allow read, write: if isAuth();
    }

  }
}
