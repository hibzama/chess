rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if request.auth.uid == userId || isAdmin();
      // Allow a user to list other users *only* if they are querying for their own referrals for a specific campaign.
      allow list: if request.auth != null && 
                     request.query.where.size == 2 &&
                     'campaignInfo.referrerId' in request.query.where &&
                     request.query.where['campaignInfo.referrerId'][2] == request.auth.uid &&
                     'campaignInfo.campaignId' in request.query.where;

      // Allow users to see their own active campaigns
      match /active_campaigns/{campaignDocId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    match /game_rooms/{roomId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == request.resource.data.createdBy.uid;
      allow update: if request.auth.uid in resource.data.players;
      allow delete: if request.auth.uid == resource.data.createdBy.uid;
    }

    match /marketing_applications/{appId} {
        allow create: if request.auth != null;
        allow read, write: if isAdmin();
    }
    
    match /transactions/{transactionId} {
        allow create: if request.auth.uid == request.resource.data.userId || isAdmin();
        allow read, update: if request.auth.uid == resource.data.userId || isAdmin();
    }
    
    // Admins can manage these collections freely
    match /signup_bonus_campaigns/{campaignId} {
        allow read: if request.auth != null; // All users can read available campaigns
        allow write: if isAdmin();
    }
    match /daily_bonus_campaigns/{campaignId} {
         allow read: if request.auth != null;
         allow write: if isAdmin();
    }
    match /referral_campaigns/{campaignId} {
         allow read: if request.auth != null;
         allow write: if isAdmin();
    }
    match /settings/{settingId} {
        allow read, write: if isAdmin();
    }

    match /bonus_claims/{claimId} {
        // A user can create a claim for themselves.
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read, update: if isAdmin();
    }

    // Subcollections for claims, tied to the campaign write-access
     match /daily_bonus_campaigns/{campaignId}/claims/{claimDoc} {
        allow read, write: if request.auth != null;
    }
     match /deposit_bonus_campaigns/{campaignId}/claims/{claimDoc} {
        allow read, write: if request.auth != null;
    }
     match /users/{userId}/bonus_claims/{claimDoc} {
        allow read, write: if request.auth.uid == userId;
    }
  }
}
