
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Game Rooms
    match /game_rooms/{roomId} {
      // Allow authenticated users to list public, waiting games for the lobby
      allow list: if request.auth != null && resource.data.isPrivate == false && resource.data.status == 'waiting';
      
      // Allow authenticated users to read any room (to join private games or view game state)
      allow get: if request.auth != null;
      
      // Allow users to create a room if they are the creator
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy.uid;
      
      // Allow updates for joining, playing, or ending a game
      allow update: if request.auth != null && request.auth.uid in resource.data.players;
      
      // Allow the creator to delete a waiting room
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy.uid && resource.data.status == 'waiting';
      
      // Messages within a game room
      match /messages/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid in resource.data.players;
      }
    }

    // Users
    match /users/{userId} {
      allow read;
      allow create;
      // Allow a user to update their own document.
      // Or allow updates from a transaction if it's a game-related payout.
      allow update: if request.auth != null && request.auth.uid == userId;
      
       match /bonus_claims/{claimId} {
        allow read, write: if request.auth.uid == userId;
      }

      match /daily_bonus_claims/{claimId} {
        allow read, write: if request.auth.uid == userId;
      }

       match /active_campaigns/{campaignDoc} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // Transactions
    match /transactions/{transactionId} {
        allow read, write: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Notifications
    match /notifications/{notificationId} {
       allow read, write: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Bonus Campaigns & Claims
    match /signup_bonus_campaigns/{campaignId} {
        allow read;
        match /claims/{claimId} {
            allow read, write: if request.auth != null;
        }
    }
    
    match /daily_bonus_campaigns/{campaignId} {
        allow read;
        match /claims/{claimId} {
            allow read, write: if request.auth != null;
        }
    }
    
    match /deposit_bonus_campaigns/{campaignId} {
        allow read;
        match /claims/{claimId} {
            allow read, write: if request.auth != null;
        }
    }
    
    match /referral_campaigns/{campaignId} {
        allow read;
    }

    match /bonus_claims/{claimId} {
        allow read, write: if request.auth != null;
    }

    // Settings
    match /settings/{settingId} {
        allow read: if request.auth != null;
    }
  }
}
